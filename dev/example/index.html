<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example · SimulatedAnnealingABC.jl</title><meta name="title" content="Example · SimulatedAnnealingABC.jl"/><meta property="og:title" content="Example · SimulatedAnnealingABC.jl"/><meta property="twitter:title" content="Example · SimulatedAnnealingABC.jl"/><meta name="description" content="Documentation for SimulatedAnnealingABC.jl."/><meta property="og:description" content="Documentation for SimulatedAnnealingABC.jl."/><meta property="twitter:description" content="Documentation for SimulatedAnnealingABC.jl."/><meta property="og:url" content="https://Eawag-SIAM.github.io/SimulatedAnnealingABC.jl/example/"/><meta property="twitter:url" content="https://Eawag-SIAM.github.io/SimulatedAnnealingABC.jl/example/"/><link rel="canonical" href="https://Eawag-SIAM.github.io/SimulatedAnnealingABC.jl/example/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SimulatedAnnealingABC.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">SimulatedAnnealingABC</a></li><li><a class="tocitem" href="../usage/">Usage</a></li><li class="is-active"><a class="tocitem" href>Example</a><ul class="internal"><li><a class="tocitem" href="#Stochastic-SIR-Model"><span>Stochastic SIR Model</span></a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../related/">Related packages</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Eawag-SIAM/SimulatedAnnealingABC.jl/blob/main/docs/src/example.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h1><p>We use a simple stochastic SIR model to demonstrate the usage of <code>SimulatedAnnealingABC.jl</code> for Bayesian inference.</p><h2 id="Stochastic-SIR-Model"><a class="docs-heading-anchor" href="#Stochastic-SIR-Model">Stochastic SIR Model</a><a id="Stochastic-SIR-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Stochastic-SIR-Model" title="Permalink"></a></h2><p>The stochastic SIR (Susceptible-Infected-Recovered) model describes the spread of an infectious disease in a closed population of <span>$N$</span> individuals. Transmission and recovery events happen at random times. The model has two parameters:</p><ul><li><span>$\beta$</span>: Infection rate per contact per unit time.</li><li><span>$\gamma$</span>: Recovery rate per infected individual per unit time.</li></ul><p>The number of susceptible, infected, and recovered individuals at time <span>$t$</span>, are denoted by <span>$S(t)$</span>, <span>$I(t)$</span>, and <span>$R(t)$</span>.</p><p>The infection rate at a given time depends on the number of susceptible and infected individuals</p><p><span>$\lambda_{\text{infection}}(t) = \frac{\beta S(t) I(t)}{N}$</span>,</p><p>while the recovery rate</p><p><span>$\lambda_{\text{recovery}})(t) = \gamma I(t)$</span></p><p>depends only on the infected individual.</p><p>Assuming a Poisson process, the time until the next event (infection or recovery), <span>$\Delta t$</span>, is  exponential distributed: <span>$\Delta t \sim \text{Exponential}(\lambda_{\text{total}})$</span></p><h3 id="Inference"><a class="docs-heading-anchor" href="#Inference">Inference</a><a id="Inference-1"></a><a class="docs-heading-anchor-permalink" href="#Inference" title="Permalink"></a></h3><h4 id="Observations"><a class="docs-heading-anchor" href="#Observations">Observations</a><a id="Observations-1"></a><a class="docs-heading-anchor-permalink" href="#Observations" title="Permalink"></a></h4><p>We cannot observe every individual. Instead, let&#39;s assume that we observe three key figures:</p><ol><li>the total number infected individuals,</li><li>the number of infected individuals at the peak of the wave, and</li><li>the time point when the wave peaked.</li></ol><p>Note, that it would be very difficult to derive the density of the likelihood function <span>$p(\text{observations} \mid \gamma, \beta)$</span> for the stochastic SIR model for this kind of observations. At the same time it is not difficult to simulate such data from our model. Therefore ABC algorithms are a good fit for this inference problem.</p><h4 id="Prior"><a class="docs-heading-anchor" href="#Prior">Prior</a><a id="Prior-1"></a><a class="docs-heading-anchor-permalink" href="#Prior" title="Permalink"></a></h4><p>For Bayesian inference we need to define a prior distribution for the parameters. Let&#39;s assume the prior for the parameters are independent uniform distributions:</p><ul><li>Transmission rate: <span>$\beta \sim \text{Uniform}(0.1, 1)$</span></li><li>Recovered rate: <span>$\gamma \sim \text{Uniform}(0.05, 0.5)$</span></li></ul><h3 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h3><p>First we load the required packages and set a random seed.</p><pre><code class="language-julia hljs">using SimulatedAnnealingABC
using Distributions
using Plots

import Random
Random.seed!(123)</code></pre><p>Then we define the stochastic SIR model</p><pre><code class="language-julia hljs">function stochastic_SIR(θ; S0::Int, I0::Int, R0::Int, t_max)

    β, γ = θ
    # Initialize variables
    S = S0
    I = I0
    R = R0
    t = 0.0
    N = S0 + I0 + R0  # Total population

    # Records of the simulation
    time = [t]
    S_record = [S]
    I_record = [I]
    R_record = [R]

    while t &lt; t_max &amp;&amp; I &gt; 0
        # Calculate rates
        infection_rate = β * S * I / N
        recovery_rate = γ * I
        total_rate = infection_rate + recovery_rate

        # Time to next event
        dt = rand(Exponential(1 / total_rate))
        t += dt

        # Determine which event occurs
        if rand() &lt; infection_rate / total_rate
            # Infection event
            S -= 1
            I += 1
        else
            # Recovery event
            I -= 1
            R += 1
        end

        # Record the state
        push!(time, t)
        push!(S_record, S)
        push!(I_record, I)
        push!(R_record, R)
    end


    return (time = time, S = S_record,
            I = I_record, R = R_record)
end</code></pre><p>For the sake of this example we simulate data. Note, the random seed has a large influence on how the simulation result looks like.</p><pre><code class="language-julia hljs"># &quot;true&quot; parameters
θtrue = [0.3,    # Transmission rate β
         0.1]    # Recovery rate γ

sim = stochastic_SIR(θtrue; S0=99, I0=1, R0=0, t_max=160)

# Plot the results
plot(sim.time, sim.S, label=&quot;Susceptible&quot;, xlabel=&quot;Time (days)&quot;, ylabel=&quot;Number of Individuals&quot;,
     title=&quot;Stochastic SIR Model&quot;, linewidth=2, linetype=:steppre)
plot!(sim.time, sim.I, label=&quot;Infected&quot;, linewidth=2, linetype=:steppre)
plot!(sim.time, sim.R, label=&quot;Recovered&quot;, linewidth=2, linetype=:steppre)</code></pre><img src="f29aefd4.svg" alt="Example block output"/><p>The observations are defined as follows:</p><pre><code class="language-julia hljs">data_obs = (
    total_infected = sim.R[end],
    peak_infected = maximum(sim.I),
    t_peak = sim.time[argmax(sim.I)]
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(total_infected = 96, peak_infected = 38, t_peak = 27.68424228379239)</code></pre><p>To use <code>sabc</code> we need to define a function that returns one or more distances between a random simulation from out model with parameter <span>$\theta$</span> and the observed data. Here we define two functions for demonstration. The first one returns the distance of each observed statistics separately and the second one aggregates them all into a single distance.</p><pre><code class="language-julia hljs">function f_dist_multi_stats(θ, data_obs)
    # run model
    sim = stochastic_SIR(θ; S0=99, I0=1, R0=0, t_max=160)

    sim_total_infected = sim.R[end]
    sim_peak_infected = maximum(sim.I)
    sim_t_peak = sim.time[argmax(sim.I)]

    # compute distance of summary statistics
    dists = (abs2(sim_total_infected - data_obs.total_infected),
             abs2(sim_peak_infected - data_obs.peak_infected),
             abs2(sim_t_peak - data_obs.t_peak))

end

# For single stat version we need to aggregate the statistics.
# Here we give the same weight to each statistic
f_dist_single_stat(θ, data_obs) = sum(f_dist_multi_stats(θ, data_obs))</code></pre><p>It is often not clear, how to aggregating the distances of multiple statistics meaningfully. For example, here we had to combined distances measured in different units (number of individuals and time in days).</p><p>The prior is defined with <code>Distributions.jl</code>:</p><pre><code class="language-julia hljs">prior = product_distribution([Uniform(0.1, 1),     # β
                              Uniform(0.05, 0.5)]) # γ</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Distributions.Product{Distributions.Continuous, Distributions.Uniform{Float64}, Vector{Distributions.Uniform{Float64}}}(v=Distributions.Uniform{Float64}[Distributions.Uniform{Float64}(a=0.1, b=1.0), Distributions.Uniform{Float64}(a=0.05, b=0.5)])</code></pre><p>With everything in place, we run the inference for both distances. Note, that the argument <code>data_obs</code> is passed to the distance functions.</p><pre><code class="language-julia hljs">res_1 = sabc(f_dist_single_stat, prior, data_obs;
             n_simulation = 500_000,
             n_particles = 5000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Approximate posterior sample with 5000 particles:
  - algorithm: :single_eps
  - simulations used: 500000
  - number of population updates: 99
  - average transformed distance: 0.005033
  - ϵ: [0.0008463]
  - number of population resamplings: 6
  - acceptance rate: 0.126
The sample can be accessed with the field `population`.
The history of ϵ can be accessed with the field `state.ϵ_history`.
The history of ρ can be accessed with the field `state.ρ_history`.
The history of u can be accessed with the field `state.u_history`.
</code></pre><pre><code class="language-julia hljs">res_2 = sabc(f_dist_multi_stats, prior, data_obs;
             n_simulation = 500_000,
             n_particles = 5000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Approximate posterior sample with 5000 particles:
  - algorithm: :single_eps
  - simulations used: 500000
  - number of population updates: 99
  - average transformed distance: 0.02193
  - ϵ: [0.005845]
  - number of population resamplings: 3
  - acceptance rate: 0.07406
The sample can be accessed with the field `population`.
The history of ϵ can be accessed with the field `state.ϵ_history`.
The history of ρ can be accessed with the field `state.ρ_history`.
The history of u can be accessed with the field `state.u_history`.
</code></pre><p>Finally, we plot the posterior parameter distribution. The multiple statistics are a bit more informative resulting in a narrower posterior.</p><pre><code class="language-julia hljs">pop_1 = stack(res_1.population)
pop_2 = stack(res_2.population)

p1 = scatter(pop_1[1,:], pop_1[2,:], title=&quot;single stat&quot;,
             markeralpha = 0.3,
             markersize = 1,
             markerstrokewidth = 0);
scatter!(p1, θtrue[1:1], θtrue[2:2], markersize = 2);

p2 = scatter(pop_2[1,:], pop_2[2,:], title=&quot;multiple stats&quot;,
             markeralpha = 0.3,
             markersize = 1,
             markerstrokewidth = 0);
scatter!(p2, θtrue[1:1], θtrue[2:2], markersize = 2);

plot(p1, p2, xlab = &quot;β&quot;, ylab = &quot;γ&quot;, legend=false)</code></pre><img src="4daca97c.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../usage/">« Usage</a><a class="docs-footer-nextpage" href="../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Friday 15 November 2024 10:21">Friday 15 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
